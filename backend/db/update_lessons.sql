-- =====================================================
-- SQL запросы из чата для управления тестами и вопросами
-- =====================================================

-- =====================================================
-- 1. СОЗДАНИЕ ТЕСТОВ К УРОКАМ
-- =====================================================

-- Создание теста к уроку с id = 2
-- Тест для проверки понимания основ трейдинга и личных целей
INSERT INTO quizzes (title, description, lesson_id, visible) 
VALUES ('Тест на понимание трейдинга', 'Тест для проверки понимания основ трейдинга и личных целей', 2, TRUE);

-- Создание теста к уроку с id = 16
-- Тест для проверки понимания соотношения риск/прибыль и расчета винрейта
INSERT INTO quizzes (title, description, lesson_id, visible) 
VALUES ('Тест на понимание риск-менеджмента', 'Тест для проверки понимания соотношения риск/прибыль и расчета винрейта', 16, TRUE);

-- Создание теста к уроку с id = 17
-- Тест для проверки понимания основ риск-менеджмента и сохранения капитала
INSERT INTO quizzes (title, description, lesson_id, visible) 
VALUES ('Тест на понимание риск-менеджмента', 'Тест для проверки понимания основ риск-менеджмента и сохранения капитала', 17, TRUE);

-- Создание теста к уроку с id = 18
-- Тест для проверки понимания стратегий торговли и подведения итогов курса
INSERT INTO quizzes (title, description, lesson_id, visible) 
VALUES ('Стратегия торговли', 'Тест для проверки понимания стратегий торговли и подведения итогов курса', 18, TRUE);

-- =====================================================
-- 2. СОЗДАНИЕ ТЕКСТОВЫХ ВОПРОСОВ
-- =====================================================

-- Создание текстовых вопросов для теста урока 2
-- Вопросы о личных целях и понимании трейдинга
INSERT INTO questions (text, type, visible) VALUES 
('Каким трейдером вы себя видите через пару месяцев?', 'text', TRUE),
('Каким трейдером вы себя видите через несколько лет?', 'text', TRUE),
('Что вас больше всего привлекает в трейдинге?', 'text', TRUE),
('Что для вас важнее в торговле: прибыль или дисциплина? Почему?', 'text', TRUE),
('Какие качества, на ваш взгляд, должен иметь успешный трейдер?', 'text', TRUE),
('Что вы уже делаете для того, чтобы развиваться как трейдер?', 'text', TRUE),
('Какие навыки вы планируете прокачать в ближайшие месяцы?', 'text', TRUE),
('Какие инструменты или рынки вам наиболее интересны?', 'text', TRUE),
('Какую роль для вас играет риск-менеджмент?', 'text', TRUE),
('Как вы планируете справляться с эмоциями в торговле?', 'text', TRUE);

-- Создание текстовых вопросов для теста урока 16
-- Вопросы о расчете риск/реварда и винрейта
INSERT INTO questions (text, type, visible) VALUES 
('Посчитайте, какой риск/ревард должен быть у вас, чтобы оставаться прибыльным с винрейтом в 40%.', 'text', TRUE),
('Подумайте, и напишите, какой риск/ревард является для вас наиболее комфортным на первый взгляд.', 'text', TRUE),
('Посчитайте свой винрейт за месяц, квартал и год, если уже занимались когда-либо торговлей.', 'text', TRUE);

-- Создание текстовых вопросов для теста урока 18
-- Вопросы о подведении итогов курса и стратегиях
INSERT INTO questions (text, type, visible) VALUES 
('Какие знания вы приобрели за данный курс? Поделитесь своими впечатлениями.', 'text', TRUE),
('Какая тема на ваш взгляд, является самой важной для старта торговли в криптовалюте?', 'text', TRUE),
('Что думаете о теме "успеха и времени"?', 'text', TRUE);

-- Создание текстовых вопросов для практических заданий
-- Вопросы о создании аккаунта и понимании ордеров
INSERT INTO questions (text, type, visible) VALUES 
('Создать аккаунт на OKX по нашей реферальной ссылке: https://www.okx.com/join/DEPARTMENT', 'text', TRUE),
('Завести деньги на аккаунт через наш обменник: https://t.me/deptexchangebot?startapp', 'text', TRUE),
('Разобраться с интерфейсом биржи', 'text', TRUE),
('Объясните на примере, чем отличается лимитный ордер от рыночного, и в каких ситуациях вы бы использовали каждый', 'text', TRUE),
('Как связаны ликвидность и волатильность? Может ли актив быть очень волатильным, но при этом ликвидным? Объясните.', 'text', TRUE);

-- =====================================================
-- 3. СОЗДАНИЕ ВОПРОСОВ ТИПА "QUIZ" С ОТВЕТАМИ
-- =====================================================

-- Создание вопросов типа "quiz" для тестирования знаний
-- Вопросы о лимитных ордерах, проскальзывании и ликвидности
INSERT INTO questions (text, type, visible) VALUES 
('Что произойдёт, если выставить лимитный ордер на покупку по цене ниже текущей рыночной?', 'quiz', TRUE),
('Что такое "проскальзывание"?', 'quiz', TRUE),
('Почему на неликвидных рынках выше риск проскальзывания?', 'quiz', TRUE),
('Какой тип ордера лучше использовать, если нужно гарантированно войти в рынок прямо сейчас?', 'quiz', TRUE),
('Как можно повысить вероятность исполнения лимитного ордера в быстро движущемся рынке?', 'quiz', TRUE);

-- Создание ответов для вопроса 1 (лимитный ордер)
INSERT INTO answers (text, correct, question_id) VALUES 
('Ордер исполнится мгновенно', FALSE, (SELECT id FROM questions WHERE text = 'Что произойдёт, если выставить лимитный ордер на покупку по цене ниже текущей рыночной?')),
('Ордер будет ждать, пока цена опустится', TRUE, (SELECT id FROM questions WHERE text = 'Что произойдёт, если выставить лимитный ордер на покупку по цене ниже текущей рыночной?')),
('Ордер автоматически отменится через 5 минут', FALSE, (SELECT id FROM questions WHERE text = 'Что произойдёт, если выставить лимитный ордер на покупку по цене ниже текущей рыночной?')),
('Ордер превратится в рыночный', FALSE, (SELECT id FROM questions WHERE text = 'Что произойдёт, если выставить лимитный ордер на покупку по цене ниже текущей рыночной?'));

-- Создание ответов для вопроса 2 (проскальзывание)
INSERT INTO answers (text, correct, question_id) VALUES 
('Когда цена уходит дальше запланированного уровня до исполнения ордера', TRUE, (SELECT id FROM questions WHERE text = 'Что такое "проскальзывание"?')),
('Ошибка терминала, из-за которой сделка не проходит', FALSE, (SELECT id FROM questions WHERE text = 'Что такое "проскальзывание"?')),
('Разница между фьючерсом и спотом', FALSE, (SELECT id FROM questions WHERE text = 'Что такое "проскальзывание"?')),
('Способ хеджирования позиции', FALSE, (SELECT id FROM questions WHERE text = 'Что такое "проскальзывание"?'));

-- Создание ответов для вопроса 3 (неликвидные рынки)
INSERT INTO answers (text, correct, question_id) VALUES 
('Потому что мало участников и ордера не находят моментально встречные заявки', TRUE, (SELECT id FROM questions WHERE text = 'Почему на неликвидных рынках выше риск проскальзывания?')),
('Потому что брокер специально задерживает исполнение', FALSE, (SELECT id FROM questions WHERE text = 'Почему на неликвидных рынках выше риск проскальзывания?')),
('Потому что такие рынки всегда в минусе', FALSE, (SELECT id FROM questions WHERE text = 'Почему на неликвидных рынках выше риск проскальзывания?')),
('Потому что комиссии выше', FALSE, (SELECT id FROM questions WHERE text = 'Почему на неликвидных рынках выше риск проскальзывания?'));

-- Создание ответов для вопроса 4 (тип ордера для входа)
INSERT INTO answers (text, correct, question_id) VALUES 
('Лимитный ордер', FALSE, (SELECT id FROM questions WHERE text = 'Какой тип ордера лучше использовать, если нужно гарантированно войти в рынок прямо сейчас?')),
('Стоп-ордер', FALSE, (SELECT id FROM questions WHERE text = 'Какой тип ордера лучше использовать, если нужно гарантированно войти в рынок прямо сейчас?')),
('Рыночный ордер', TRUE, (SELECT id FROM questions WHERE text = 'Какой тип ордера лучше использовать, если нужно гарантированно войти в рынок прямо сейчас?'));

-- Создание ответов для вопроса 5 (повышение вероятности исполнения)
INSERT INTO answers (text, correct, question_id) VALUES 
('Выставить цену ближе к рыночной', TRUE, (SELECT id FROM questions WHERE text = 'Как можно повысить вероятность исполнения лимитного ордера в быстро движущемся рынке?')),
('Ждать, пока рынок сам придёт к вашей цене', FALSE, (SELECT id FROM questions WHERE text = 'Как можно повысить вероятность исполнения лимитного ордера в быстро движущемся рынке?')),
('Уменьшить объём сделки до минимума', FALSE, (SELECT id FROM questions WHERE text = 'Как можно повысить вероятность исполнения лимитного ордера в быстро движущемся рынке?'));

-- =====================================================
-- 4. ПРИВЯЗКА ВОПРОСОВ К ТЕСТАМ
-- =====================================================

-- Привязка текстовых вопросов к тесту урока 2
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    (SELECT id FROM quizzes WHERE lesson_id = 2 AND title = 'Тест на понимание трейдинга'),
    id
FROM questions 
WHERE text IN (
    'Каким трейдером вы себя видите через пару месяцев?',
    'Каким трейдером вы себя видите через несколько лет?',
    'Что вас больше всего привлекает в трейдинге?',
    'Что для вас важнее в торговле: прибыль или дисциплина? Почему?',
    'Какие качества, на ваш взгляд, должен иметь успешный трейдер?',
    'Что вы уже делаете для того, чтобы развиваться как трейдер?',
    'Какие навыки вы планируете прокачать в ближайшие месяцы?',
    'Какие инструменты или рынки вам наиболее интересны?',
    'Какую роль для вас играет риск-менеджмент?',
    'Как вы планируете справляться с эмоциями в торговле?'
);

-- Привязка текстовых вопросов к тесту урока 16
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    (SELECT id FROM quizzes WHERE lesson_id = 16 AND title = 'Тест на понимание риск-менеджмента'),
    id
FROM questions 
WHERE text IN (
    'Посчитайте, какой риск/ревард должен быть у вас, чтобы оставаться прибыльным с винрейтом в 40%.',
    'Подумайте, и напишите, какой риск/ревард является для вас наиболее комфортным на первый взгляд.',
    'Посчитайте свой винрейт за месяц, квартал и год, если уже занимались когда-либо торговлей.'
);

-- Привязка текстовых вопросов к тесту урока 18
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    (SELECT id FROM quizzes WHERE lesson_id = 18 AND title = 'Стратегия торговли'),
    id
FROM questions 
WHERE text IN (
    'Какие знания вы приобрели за данный курс? Поделитесь своими впечатлениями.',
    'Какая тема на ваш взгляд, является самой важной для старта торговли в криптовалюте?',
    'Что думаете о теме "успеха и времени"?'
);

-- =====================================================
-- 5. КОПИРОВАНИЕ ВОПРОСОВ МЕЖДУ УРОКАМИ
-- =====================================================

-- Копирование вопросов из задания к уроку 5 в задание к уроку 16
-- Копирует все вопросы из теста "Понимаешь ли ты WinRate и RR?" в тест риск-менеджмента
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    (SELECT id FROM quizzes WHERE lesson_id = 16 AND title = 'Тест на понимание риск-менеджмента'),
    qq.question_id
FROM quiz_questions qq
JOIN quizzes q ON qq.quiz_id = q.id
WHERE q.lesson_id = 5;

-- Копирование вопросов из задания к уроку 6 в задание к уроку 17
-- Копирует все вопросы из теста "Понимаешь ли ты суть риск-менеджмента?" в новый тест
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    (SELECT id FROM quizzes WHERE lesson_id = 17 AND title = 'Тест на понимание риск-менеджмента'),
    qq.question_id
FROM quiz_questions qq
JOIN quizzes q ON qq.quiz_id = q.id
WHERE q.lesson_id = 6;

-- =====================================================
-- 6. УПРАВЛЕНИЕ СУЩЕСТВУЮЩИМИ ТЕСТАМИ
-- =====================================================

-- Полная перестройка теста quiz_id = 11
-- Шаг 1: Удаление всех существующих вопросов из теста
DELETE FROM quiz_questions WHERE quiz_id = 11;

-- Шаг 2: Копирование вопросов из задания урока = 2 в тест quiz_id = 11
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    11,
    qq.question_id
FROM quiz_questions qq
JOIN quizzes q ON qq.quiz_id = q.id
WHERE q.lesson_id = 2;

-- Шаг 3: Привязка вопросов типа "quiz" к тесту quiz_id = 11
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    11,
    id
FROM questions 
WHERE text IN (
    'Что произойдёт, если выставить лимитный ордер на покупку по цене ниже текущей рыночной?',
    'Что такое "проскальзывание"?',
    'Почему на неликвидных рынках выше риск проскальзывания?',
    'Какой тип ордера лучше использовать, если нужно гарантированно войти в рынок прямо сейчас?',
    'Как можно повысить вероятность исполнения лимитного ордера в быстро движущемся рынке?'
);

-- Шаг 4: Привязка практических текстовых вопросов к тесту quiz_id = 11
INSERT INTO quiz_questions (quiz_id, question_id)
SELECT 
    11,
    id
FROM questions 
WHERE text IN (
    'Создать аккаунт на OKX по нашей реферальной ссылке: https://www.okx.com/join/DEPARTMENT',
    'Завести деньги на аккаунт через наш обменник: https://t.me/deptexchangebot?startapp',
    'Разобраться с интерфейсом биржи',
    'Объясните на примере, чем отличается лимитный ордер от рыночного, и в каких ситуациях вы бы использовали каждый',
    'Как связаны ликвидность и волатильность? Может ли актив быть очень волатильным, но при этом ликвидным? Объясните.'
);

-- =====================================================
-- ПРИМЕЧАНИЯ ПО ИСПОЛЬЗОВАНИЮ
-- =====================================================

-- 1. Выполняйте запросы в указанном порядке
-- 2. Сначала создавайте тесты, затем вопросы, потом ответы, и в конце привязки
-- 3. При копировании вопросов убедитесь, что исходные тесты существуют
-- 4. Для quiz_id = 11 используйте все 4 шага перестройки последовательно
-- 5. Проверяйте существование вопросов перед их привязкой к тестам


-- Запрос для переноса материалов из одного урока в другой
INSERT INTO materials (title, description, url, visible, lesson_id)
SELECT 
    title,
    description,
    url,
    visible,
    14
FROM materials 
WHERE lesson_id = 1;