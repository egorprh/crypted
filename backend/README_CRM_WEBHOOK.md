# CRM Webhook Integration

## Описание

Функция `send_survey_to_crm` из модуля `misc.py` автоматически отправляет данные пользователя и его ответы на входной опрос в CRM систему через webhook при прохождении опроса `enter_survey`.

## Настройка

### 1. Добавьте переменную окружения

В файле `.env` добавьте URL вашего CRM webhook:

```env
CRM_WEBHOOK_URL=https://your-crm.com/webhook/survey-data
```

### 2. Структура данных

Функция отправляет POST запрос со следующей структурой данных:

```json
{
  "user": {
    "telegram_id": 123456789,
    "username": "user_name",
    "first_name": "Имя",
    "last_name": "Фамилия",
    "level": "Начинающий",
    "level_id": 1
  },
  "survey_answers": [
    {
      "question": "Ваш возраст?",
      "answer": "25"
    },
    {
      "question": "Ваш опыт в трейдинге?",
      "answer": "Начинающий"
    }
  ],
  "timestamp": "2024-01-15T10:30:00",
  "event_type": "enter_survey"
}
```

## Логирование

Функция логирует все операции:
- Успешная отправка: `INFO` уровень
- Ошибки отправки: `ERROR` уровень
- Отсутствие URL: `WARNING` уровень

## Тестирование

Для запуска юнит-тестов используйте:

```bash
cd tests
python -m pytest test_crm_webhook.py -v
```

Тесты работают без запуска Docker и покрывают:
- Успешную отправку данных
- Обработку отсутствия webhook URL
- Обработку HTTP ошибок
- Обработку исключений
- Функцию `remove_timestamps`

## Обработка ошибок

- Если CRM webhook URL не настроен, функция пропускает отправку без ошибок
- Ошибки HTTP запросов логируются, но не прерывают основную логику
- Таймаут запроса: 30 секунд

## Интеграция

Функция автоматически вызывается при событии `enter_survey` в `trigger_event()` и выполняется асинхронно, не блокируя основной поток.

## Структура кода

- `misc.py` - модуль с функциями `send_survey_to_crm` и `remove_timestamps`
- `main.py` - импортирует функции из `misc.py`
- `tests/test_crm_webhook.py` - юнит-тесты для функций
