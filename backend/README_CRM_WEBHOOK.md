# CRM Webhook Integration

## Описание

Функция `send_survey_to_crm` из модуля `misc.py` автоматически отправляет данные пользователя и его ответы на входной опрос в CRM систему через webhook при прохождении опроса `enter_survey`.

## Настройка

### 1. Добавьте переменную окружения

В файле `.env` добавьте URL вашего CRM webhook:

```env
CRM_WEBHOOK_URL=https://your-crm.com/webhook/survey-data
```

### 2. Структура данных

Функция отправляет POST запрос со следующей структурой данных:

```json
{
  "type": "enter_survey",
  "telegram_id": 123456789,
  "username": "user_name",
  "level_id": 1,
  "level": "Начинающий",
  "name": "Иван Иванов",
  "age": "25",
  "phone": "+7 (999) 123-45-67"
}
```

**Описание полей:**
- `type`: Тип данных (всегда "enter_survey")
- `telegram_id`: ID пользователя в Telegram
- `username`: Имя пользователя в Telegram
- `level_id`: ID уровня пользователя
- `level`: Название уровня пользователя
- `name`: Имя пользователя (извлечено из опроса по ключевым словам: "имя", "как вас зовут", "фамилия", "фио", "name")
- `age`: Возраст пользователя (извлечено из опроса по ключевым словам: "возраст", "лет", "age")
- `phone`: Телефон пользователя (извлечено из опроса по ключевым словам: "телефон", "phone", "номер")

## Логирование

Функция логирует все операции:
- Исходные данные опроса: `INFO` уровень
- Payload для отправки: `INFO` уровень
- Успешная отправка: `INFO` уровень
- Ответ сервера CRM: `INFO` уровень
- Ошибки отправки: `ERROR` уровень
- Отсутствие URL: `WARNING` уровень

## Тестирование

Для запуска юнит-тестов используйте:

```bash
cd tests
python -m pytest test_crm_webhook.py -v
```

Тесты работают без запуска Docker и покрывают:
- Успешную отправку данных
- Обработку отсутствия webhook URL
- Обработку HTTP ошибок
- Обработку исключений
- Функцию `remove_timestamps`

## Обработка ошибок

- Если CRM webhook URL не настроен, функция пропускает отправку без ошибок
- Ошибки HTTP запросов логируются, но не прерывают основную логику
- Таймаут запроса: 30 секунд

## Интеграция

Функция автоматически вызывается при событии `enter_survey` в `trigger_event()` и выполняется асинхронно, не блокируя основной поток.

## Структура кода

- `misc.py` - модуль с функциями `send_survey_to_crm` и `remove_timestamps`
- `main.py` - импортирует функции из `misc.py`
- `tests/test_crm_webhook.py` - юнит-тесты для функций

# CRM Webhook Integration для домашних заданий

## Описание

Функция `send_homework_to_crm` из модуля `misc.py` автоматически отправляет данные о выполненном домашнем задании в CRM систему через webhook при завершении теста/задания.

## Настройка

### 1. Добавьте переменную окружения

В файле `.env` добавьте URL вашего CRM webhook (используется тот же URL, что и для опросов):

```env
CRM_WEBHOOK_URL=https://your-crm.com/webhook/survey-data
```

### 2. Структура данных

Функция отправляет POST запрос со следующей структурой данных:

```json
{
  "type": "homework",
  "telegram_id": 123456789,
  "username": "user_name",
  "phone": "+7 (999) 123-45-67",
  "course_id": 1,
  "course_name": "Название курса",
  "lesson_id": 1,
  "lesson_name": "Название урока",
  "progress": 75.0,
  "question_1": "Текст первого вопроса",
  "answer_1": "Ответ на первый вопрос",
  "correct_1": true,
  "question_2": "Текст второго вопроса",
  "answer_2": "Ответ на второй вопрос",
  "correct_2": false,
  "question_N": "...",
  "answer_N": "...",
  "correct_N": true
}
```

**Описание полей:**
- `type`: Тип данных (всегда "homework")
- `telegram_id`: ID пользователя в Telegram
- `username`: Имя пользователя в Telegram
- `phone`: Номер телефона пользователя (получается из ответов на вопросы типа 'phone' в опросах)
- `course_id`: ID курса
- `course_name`: Название курса
- `lesson_id`: ID урока
- `lesson_name`: Название урока
- `progress`: Процент правильных ответов (число с одним знаком после запятой, например 75.0)
- `question_N`: Текст N-го вопроса
- `answer_N`: Ответ пользователя на N-й вопрос
- `correct_N`: Правильность ответа (true/false)

## Логика работы

1. **Триггер**: Функция вызывается автоматически при завершении домашнего задания через `send_homework_notification`
2. **Получение данных**: Собираются данные о пользователе, курсе, уроке и всех вопросах/ответах
3. **Получение телефона**: Используется функция `get_user_phone_number` для получения номера телефона из ответов на опросы
4. **Формирование payload**: Создается структурированный объект с данными о задании
5. **Отправка**: POST запрос отправляется в CRM webhook
6. **Логирование**: Все операции логируются для отладки

## Обработка ошибок

- При отсутствии CRM webhook URL функция пропускает отправку с предупреждением
- При ошибках HTTP запроса логируется ошибка, но основная логика не прерывается
- При ошибках получения данных (телефон, информация о курсе/уроке) используется fallback значения

## Логирование

Функция логирует все операции:
- Payload для отправки: `INFO` уровень
- Успешная отправка: `INFO` уровень
- Ответ сервера CRM: `INFO` уровень
- Ошибки: `ERROR` уровень

## Интеграция

Функция интегрирована в существующий процесс:
1. Пользователь завершает домашнее задание
2. Вызывается `send_homework_notification`
3. Отправляется уведомление в Telegram канал
4. Автоматически вызывается `send_homework_to_crm`
5. Данные отправляются в CRM webhook

## Пример использования

```python
# Функция вызывается автоматически при завершении задания
# Ручной вызов (для тестирования):
payload = {
    "type": "homework",
    "telegram_id": 123456789,
    "username": "user_name",
    "phone": "+7 (999) 123-45-67",
    "course_id": 1,
    "course_name": "Курс по Python",
    "lesson_id": 1,
    "lesson_name": "Введение в Python",
    "progress": 100.0,
    "question_1": "Что такое переменная?",
    "answer_1": "Именованная область памяти",
    "correct_1": True
}

await send_homework_to_crm(payload)
```
