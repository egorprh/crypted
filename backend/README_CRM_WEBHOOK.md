# CRM Webhook Integration

## Описание

Функция `send_survey_to_crm` из модуля `misc.py` автоматически отправляет данные пользователя и его ответы на входной опрос в CRM систему через webhook при прохождении опроса `enter_survey`.

## Настройка

### 1. Добавьте переменную окружения

В файле `.env` добавьте URL вашего CRM webhook:

```env
CRM_WEBHOOK_URL=https://your-crm.com/webhook/survey-data
```

### 2. Структура данных

Функция отправляет POST запрос со следующей структурой данных:

```json
{
  "telegram_id": 123456789,
  "username": "user_name",
  "level_id": 1,
  "level": "Начинающий",
  "name": "Иван Иванов",
  "age": "25",
  "phone": "+7 (999) 123-45-67"
}
```

**Описание полей:**
- `telegram_id`: ID пользователя в Telegram
- `username`: Имя пользователя в Telegram
- `level_id`: ID уровня пользователя
- `level`: Название уровня пользователя
- `name`: Имя пользователя (извлечено из опроса по ключевым словам: "имя", "как вас зовут", "фамилия", "фио", "name")
- `age`: Возраст пользователя (извлечено из опроса по ключевым словам: "возраст", "лет", "age")
- `phone`: Телефон пользователя (извлечено из опроса по ключевым словам: "телефон", "phone", "номер")

## Логирование

Функция логирует все операции:
- Исходные данные опроса: `INFO` уровень
- Payload для отправки: `INFO` уровень
- Успешная отправка: `INFO` уровень
- Ответ сервера CRM: `INFO` уровень
- Ошибки отправки: `ERROR` уровень
- Отсутствие URL: `WARNING` уровень

## Тестирование

Для запуска юнит-тестов используйте:

```bash
cd tests
python -m pytest test_crm_webhook.py -v
```

Тесты работают без запуска Docker и покрывают:
- Успешную отправку данных
- Обработку отсутствия webhook URL
- Обработку HTTP ошибок
- Обработку исключений
- Функцию `remove_timestamps`

## Обработка ошибок

- Если CRM webhook URL не настроен, функция пропускает отправку без ошибок
- Ошибки HTTP запросов логируются, но не прерывают основную логику
- Таймаут запроса: 30 секунд

## Интеграция

Функция автоматически вызывается при событии `enter_survey` в `trigger_event()` и выполняется асинхронно, не блокируя основной поток.

## Структура кода

- `misc.py` - модуль с функциями `send_survey_to_crm` и `remove_timestamps`
- `main.py` - импортирует функции из `misc.py`
- `tests/test_crm_webhook.py` - юнит-тесты для функций
