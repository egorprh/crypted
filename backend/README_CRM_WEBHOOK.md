# CRM Webhook Integration

## Описание

Система автоматически отправляет данные в CRM через webhook при двух событиях:
1. **Входное тестирование** - функция `send_survey_to_crm` отправляет данные пользователя и его ответы на входной опрос
2. **Домашние задания** - функция `send_homework_to_crm` отправляет данные о выполненном задании

## Настройка

### 1. Добавьте переменные окружения

В файле `.env` добавьте URL ваших CRM webhook:

```env
# URL для отправки данных входного тестирования
CRM_SURVEY_WEBHOOK_URL=https://your-crm.com/webhook/survey-data

# URL для отправки данных домашних заданий
CRM_HOMEWORK_WEBHOOK_URL=https://your-crm.com/webhook/homework-data
```

### 2. Структура данных

#### Входное тестирование (type: "enter_survey")

Функция `send_survey_to_crm` отправляет POST запрос на `CRM_SURVEY_WEBHOOK_URL` со следующей структурой данных:

```json
{
  "type": "enter_survey",
  "telegram_id": 123456789,
  "username": "user_name",
  "level_id": 1,
  "level": "Начинающий",
  "name": "Иван Иванов",
  "age": "25",
  "phone": "+7 (999) 123-45-67"
}
```

**Описание полей:**
- `type`: Тип данных (всегда "enter_survey")
- `telegram_id`: ID пользователя в Telegram
- `username`: Имя пользователя в Telegram
- `level_id`: ID уровня пользователя
- `level`: Название уровня пользователя
- `name`: Имя пользователя (извлечено из опроса по ключевым словам: "имя", "как вас зовут", "фамилия", "фио", "name")
- `age`: Возраст пользователя (извлечено из опроса по ключевым словам: "возраст", "лет", "age")
- `phone`: Телефон пользователя (извлечено из опроса по ключевым словам: "телефон", "phone", "номер")

#### Домашние задания (type: "homework")

Функция `send_homework_to_crm` отправляет POST запрос на `CRM_HOMEWORK_WEBHOOK_URL` со следующей структурой данных:

```json
{
  "type": "homework",
  "telegram_id": 123456789,
  "username": "user_name",
  "phone": "+7 (999) 123-45-67",
  "course_id": 1,
  "course_name": "Название курса",
  "lesson_id": 1,
  "lesson_name": "Название урока",
  "progress": 75.0,
  "question_1": "Текст первого вопроса",
  "answer_1": "Ответ на первый вопрос",
  "correct_1": true,
  "question_2": "Текст второго вопроса",
  "answer_2": "Ответ на второй вопрос",
  "correct_2": false
}
```

**Описание полей:**
- `type`: Тип данных (всегда "homework")
- `telegram_id`: ID пользователя в Telegram
- `username`: Имя пользователя в Telegram
- `phone`: Номер телефона пользователя (получается из ответов на вопросы типа 'phone' в опросах)
- `course_id`: ID курса
- `course_name`: Название курса
- `lesson_id`: ID урока
- `lesson_name`: Название урока
- `progress`: Процент правильных ответов (число с одним знаком после запятой, например 75.0)
- `question_N`: Текст N-го вопроса
- `answer_N`: Ответ пользователя на N-й вопрос
- `correct_N`: Правильность ответа (true/false)

## Логирование

Функция логирует все операции:
- Исходные данные опроса: `INFO` уровень
- Payload для отправки: `INFO` уровень
- Успешная отправка: `INFO` уровень
- Ответ сервера CRM: `INFO` уровень
- Ошибки отправки: `ERROR` уровень
- Отсутствие URL: `WARNING` уровень

## Тестирование

Для запуска юнит-тестов используйте:

```bash
cd tests
python -m pytest test_crm_webhook.py -v
```

Тесты работают без запуска Docker и покрывают:
- Успешную отправку данных
- Обработку отсутствия webhook URL
- Обработку HTTP ошибок
- Обработку исключений
- Функцию `remove_timestamps`

## Обработка ошибок

- Если CRM webhook URL не настроен, функция пропускает отправку без ошибок
- Ошибки HTTP запросов логируются, но не прерывают основную логику
- Таймаут запроса: 30 секунд

## Интеграция

Функция автоматически вызывается при событии `enter_survey` в `trigger_event()` и выполняется асинхронно, не блокируя основной поток.

## Структура кода

- `misc.py` - модуль с функциями `send_survey_to_crm` и `remove_timestamps`
- `main.py` - импортирует функции из `misc.py`
- `tests/test_crm_webhook.py` - юнит-тесты для функций
