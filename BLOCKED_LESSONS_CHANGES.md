# Изменения для добавления блокировки уроков

## Описание функциональности

Добавлена возможность блокировки уроков на основе выполнения предыдущих уроков. Урок считается заблокированным, если:
1. У предыдущего урока есть задания и они не выполнены
2. У предыдущего урока нет заданий и он не просмотрен

## Внесенные изменения

### 1. База данных (`backend/db/init.sql`)
- Добавлено поле `completion_on BOOLEAN DEFAULT FALSE` в таблицу `courses`
- Поле управляет включением/отключением отслеживания выполнения уроков

### 2. Модели данных
- **`backend/admin/models.py`**: Добавлено поле `completion_on` в модель Course
- **`backend/db/models.py`**: Добавлено поле `completion_on: bool = False` в модель Course

### 3. Админка (`backend/admin/views.py`)
- Добавлено поле `completion_on` в отображаемые колонки CourseAdmin
- Добавлен русский лейбл "Отслеживание выполнения" для поля

### 4. Вспомогательные функции (`backend/misc.py`)
Добавлены новые функции с подробными комментариями:

- **`is_lesson_completed(user_id, lesson_id, db)`** - проверяет завершение урока (выполнение заданий)
- **`is_lesson_viewed(user_id, lesson_id, db)`** - проверяет просмотр урока
- **`get_previous_lesson(course_id, current_sort_order, db)`** - получает предыдущий урок
- **`check_lesson_blocked(user_id, lesson, course, db)`** - основная логика проверки блокировки

### 5. API endpoints (`backend/main.py`)
- Добавлен новый endpoint `/api/lesson_viewed` для записи события просмотра урока
- Модифицирован метод `get_app_data` для добавления ключа `blocked` к каждому уроку
- Добавлен импорт функции `check_lesson_blocked`

### 6. Фронтенд
- **`frontend/src/components/Lessons/Lessons.jsx`**:
  - Добавлена функция `goToLesson()` для записи события просмотра урока
  - Событие записывается при клике по уроку в списке (аналогично курсам)
  - Добавлена логика отображения заблокированных уроков:
    - Мьютирование карточки и бейджа (opacity: 0.6-0.7)
    - Замена названия на "Доступно после прохождения предыдущего урока"
    - Замена стрелки на иконку замочка
    - Отключение кликабельности для заблокированных уроков

- **`frontend/src/components/Lessons/lessons.css`**:
  - Добавлены стили для заблокированных состояний:
    - `.lesson-block--blocked` - мьютирование всего блока
    - `.lesson-badge--blocked` - мьютирование бейджа
    - `.lesson-card--blocked` - мьютирование карточки и курсор not-allowed
    - `.lesson-title--blocked` - стили для текста блокировки

- **`frontend/src/components/Lesson/Lesson.jsx`**:
  - Добавлена кнопка "Далее" для навигации к материалам урока

- **`frontend/src/components/LessonMaterials/LessonMaterials.jsx`**:
  - Добавлена кнопка "Далее" для навигации к тесту урока

## Логика работы

### Алгоритм проверки блокировки:
1. **Проверка флага `completion_on`**: если `False`, урок всегда доступен
2. **Проверка первого урока**: если `sort_order = 0`, урок доступен
3. **Проверка предыдущего урока**:
   - Если есть задания: проверяется их выполнение (любая попытка)
   - Если нет заданий: проверяется просмотр урока

### События:
- **`lesson_viewed`** - записывается при открытии урока пользователем
- События сохраняются в таблице `user_actions_log`

## Настройка

Администратор может управлять отслеживанием выполнения через админку:
- Включить/отключить отслеживание для каждого курса
- По умолчанию отслеживание отключено (`completion_on = FALSE`)

## Тестирование

Функциональность протестирована с помощью мок-объектов:
- ✅ Курс с отключенным отслеживанием
- ✅ Первый урок (всегда доступен)
- ✅ Урок с выполненным предыдущим
- ✅ Урок с просмотренным предыдущим (без заданий)

## Совместимость

Все изменения обратно совместимы:
- Существующие курсы по умолчанию не используют отслеживание
- Новые курсы можно настроить индивидуально
- Не влияет на существующую функциональность
