# Тесты для функционала времени доступа к курсам

## Описание

Этот набор тестов проверяет функциональность работы с записями пользователей на курсы, включая:

- Создание записей при первом входе в курс
- Проверку и обновление статуса записей при истечении времени доступа
- Корректность работы констант статусов подписки
- **Отправку данных опроса в CRM через webhook**

## Запуск тестов

### Запуск всех тестов
```bash
python tests/run_tests.py
```

### Запуск конкретного теста
```bash
python -m unittest tests.test_enrollment.TestEnrollmentFunctions.test_create_user_enrollment_new_enrollment
```

### Запуск с подробным выводом
```bash
python -m unittest tests.test_enrollment -v
```

### Запуск тестов CRM webhook
```bash
# Полные юнит-тесты с pytest
python3 -m pytest test_crm_webhook.py -v

# Быстрый тест без pytest
python3 quick_test_crm.py
```

## Структура тестов

### test_enrollment_simple.py
Содержит простые unit тесты для:
- Константы статусов подписки
- Логика вычисления времени доступа
- Структура данных записи пользователя на курс
- Валидация входных данных

### test_enrollment.py
Содержит асинхронные unit тесты для функций:
- `create_user_enrollment()` - создание записи пользователя на курс
- `update_user_enrollment()` - обновление статуса записи при истечении времени
- `get_course_access_info()` - получение информации о времени доступа и статусе записи

### test_crm_webhook.py
Содержит юнит-тесты для функций CRM интеграции:
- `send_survey_to_crm()` - отправка данных опроса в CRM
- `remove_timestamps()` - очистка временных меток из данных
- Покрывает успешные сценарии, ошибки HTTP, отсутствие конфигурации

### quick_test_crm.py
Быстрый тест для проверки работы функции `send_survey_to_crm` без pytest

## Особенности

- Тесты работают без поднятия базы данных и бэкенда
- Используются моки для имитации работы с базой данных и HTTP запросов
- Все функции покрыты позитивными и негативными сценариями
- Тесты проверяют обработку исключений
- **CRM тесты работают без Docker и внешних зависимостей**

## Требования

- Python 3.7+
- unittest (входит в стандартную библиотеку Python)
- pytest (для CRM тестов)
- pytest-asyncio (для асинхронных тестов)
- pytest-mock (для моков)
- Модули из backend/ (импортируются автоматически)
