# Система уведомлений Telegram бота

## Обзор

Система персональных уведомлений для пользователей курсов с динамическим контентом на основе прогресса обучения. Уведомления создаются заранее в базе данных и отправляются воркером в запланированное время.

## Логика работы

### Типы пользователей и уведомления

#### Новички/Средний уровень
1. **Приветственные сообщения** (независимо от курса):
   - Через 3 минуты: приветствие и информация о курсе
   - Через 3.5 минуты: информация о домашних заданиях

2. **Прогресс-слоты** (только для курсов с `enable_notify=True`):
   - **День 1, 19:34**: сообщение в зависимости от прогресса
   - **День 2, 20:22**: напоминание о завершении
   - **День 3, 08:28**: финальное напоминание

3. **Уведомления об окончании доступа**:
   - Сразу при истечении доступа
   - Через 5 секунд: предложение продлить доступ

#### Профи
1. **Приветственные сообщения** (независимо от курса):
   - Через 12 минут: приветствие и предложение торговой группы
   - Через сутки: напоминание о ссылке

### Динамический контент

Прогресс-слоты содержат разные сообщения в зависимости от количества завершенных уроков:

- **0 уроков** (`none`): мотивация начать обучение
- **1-2 урока** (`lt3`): поощрение за начало
- **3-4 урока** (`lt5`): мотивация завершить
- **5+ уроков** (`all`): поздравление и предложение сертификата

### Умная отмена уведомлений

Если пользователь завершил все уроки курса (получил сообщение типа `all`), все последующие прогресс-слоты для этого курса автоматически отменяются.

## Техническая реализация

### Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Backend API   │───▶│  Notifications   │───▶│  Telegram Bot   │
│                 │    │     Queue        │    │     Worker      │
│ - save_level()  │    │   (Database)     │    │                 │
│ - enrollment    │    │                  │    │ - resolve_text  │
│   expiration    │    │                  │    │ - send_message  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### База данных

#### Таблица `notifications`
```sql
CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    course_id BIGINT DEFAULT 0,           -- 0 = независимо от курса
    telegram_id BIGINT NOT NULL,
    message TEXT NOT NULL,                -- маркер сообщения
    scheduled_at TIMESTAMP WITH TIME ZONE,
    sent_at TIMESTAMP WITH TIME ZONE,
    status VARCHAR(16) DEFAULT 'pending', -- pending|sent|failed|cancelled
    attempts INT DEFAULT 0,
    max_attempts INT DEFAULT 5,
    dedup_key VARCHAR(128) UNIQUE,        -- идемпотентность
    ext_data TEXT DEFAULT '{}',           -- метаданные
    time_created TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    time_modified TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### Таблица `courses`
```sql
ALTER TABLE courses ADD COLUMN enable_notify BOOLEAN DEFAULT FALSE;
```

### Ключевые компоненты

#### 1. Планировщик уведомлений (`backend/notifications/notifications.py`)

- **`schedule_welcome_notifications()`** - создает приветственные сообщения
- **`schedule_on_user_created()`** - создает прогресс-слоты для конкретного курса
- **`schedule_access_end_notifications()`** - уведомления об окончании доступа
- **`enqueue_notification()`** - универсальная функция постановки в очередь

#### 2. Воркер уведомлений (`telegram_bot/learn_notify.py`)

- **`notification_worker()`** - основной цикл обработки очереди
- **`resolve_message_text()`** - резолв маркеров в текст с учетом прогресса
- **`send_telegram_message()`** - отправка с ретраями
- **`_cancel_future_progress_slots_if_completed()`** - умная отмена уведомлений

#### 3. Тексты сообщений (`telegram_bot/notification_texts.py`)

Константы для всех типов сообщений с поддержкой плейсхолдеров:
```python
WELCOME_1 = "Привет! Увидел регистрацию..."
DAY1_1934 = {
    "none": "Добрый вечер! Вижу, еще не начали обучение...",
    "lt3": "Добрый вечер! Вижу уже начали обучение...",
    "lt5": "Добрый вечер! Вижу уже прошли больше чем 90%...",
    "all": "Поздравляю! Хоть обучение и не было..."
}
```

### Идемпотентность

Система защищена от дублирования уведомлений через:
- **`dedup_key`** - уникальный ключ вида `{telegram_id}:{kind}:{time_bucket}`
- **Уникальный индекс** по `dedup_key` в БД
- **Обработка конфликтов** при вставке

### Обработка ошибок

- **Ретраи отправки** - до 5 попыток с задержкой
- **Graceful degradation** - при ошибках резолва сообщение помечается как failed
- **Логирование** - подробные логи всех операций
- **Отмена зависимых уведомлений** - при критических ошибках

### Интеграция с курсами

- **Фильтрация по `enable_notify`** - прогресс-слоты создаются только для курсов с включенными уведомлениями
- **Привязка к курсу** - прогресс проверяется по конкретному курсу
- **Динамические названия** - в тексты подставляется название курса

### Админка

Уведомления отображаются в SQLAdmin с возможностью:
- Просмотра всех уведомлений
- Поиска по `telegram_id`
- Редактирования статусов
- Мониторинга статистики

## Запуск и мониторинг

### Статистика уведомлений
```
/notifications_stats - показывает:
- Общее количество уведомлений
- По статусам (pending, sent, failed, cancelled)
- Готовые к отправке
```

### Логи
Все операции логируются с указанием:
- ID уведомления
- Telegram ID пользователя
- Курс (если применимо)
- Результат операции

## Конфигурация

### Включение уведомлений для курса
```sql
UPDATE courses SET enable_notify = TRUE WHERE id = {course_id};
```

### Настройка времени отправки
Время отправки настраивается в функциях планирования:
- Приветственные: `enrolled_at + timedelta(minutes=3)`
- Прогресс-слоты: `_at_next_day_time(enrolled_at, hour, minute, day_offset)`

### Максимальные попытки
По умолчанию: 5 попыток отправки с экспоненциальной задержкой.

## Тестирование

### Структура тестов

Система уведомлений покрыта комплексными тестами в папке `tests/notifications/`:

#### 1. **`test_notifications_custom.py`** - Базовые unit-тесты
- Генерация `dedup_key` с временными бакетами
- Функция `enqueue_notification` с идемпотентностью
- Планирование уведомлений по уровням пользователей
- Резолв сообщений с моками БД

#### 2. **`test_notifications_comprehensive.py`** - Комплексные тесты
- Создание уведомлений для новичков и профи
- Дедупликация уведомлений
- Уведомления об окончании доступа
- Разделение уведомлений по `telegram_id`
- Проверка форматов `dedup_key`
- Граничные случаи и обработка ошибок
- Производительность при большом количестве уведомлений

#### 3. **`test_notifications_integration.py`** - Интеграционные тесты
- Интеграция с API `save_level`
- Изменения уровней пользователей
- Консистентность статусов уведомлений
- Формат `ext_data`
- Очистка при удалении пользователей
- Дедупликация с разным временем

#### 4. **`test_notifications_performance.py`** - Тесты производительности
- Массовое создание пользователей (50+)
- Конкурентное создание уведомлений
- Производительность запросов к БД
- Дедупликация в многопоточной среде
- Смешанные типы уведомлений
- Очистка тестовых данных
- Использование памяти (требует `psutil`)

#### 5. **`test_integration_real.py`** - Реальные интеграционные тесты
- Отправка в реальный Telegram (ID: 342799025)
- Обработка несуществующих Telegram ID
- Логика умной отмены уведомлений
- Резолв сообщений по реальному прогрессу
- Полные циклы для новичков и профи
- Проверка курсов с включенными/выключенными уведомлениями
- Обработка ошибок Telegram API
- Обработка ошибок БД
- Массовая обработка уведомлений
- Специальные символы и длинные сообщения

#### 6. **`test_user_scenarios.py`** - Пользовательские сценарии
- **Профи**: полный цикл с 2 приветственными сообщениями
- **Новички**:
  - Без прогресса за 3 дня (все 5 уведомлений)
  - Завершение в первый день (отмена будущих прогресс-слотов)
  - Завершение во второй день
  - Различные комбинации прогресса
  - Курсы без уведомлений
  - Истечение доступа
- День-за-днем прогресс
- Поздние стартеры

### Запуск тестов

```bash
# Все тесты уведомлений
python3 -m pytest tests/notifications/ -v

# Конкретный файл
python3 -m pytest tests/notifications/test_notifications_custom.py -v

# Конкретный тест
python3 -m pytest tests/notifications/test_integration_real.py::TestIntegrationReal::test_send_to_real_telegram_id -v

# С покрытием
python3 -m pytest tests/notifications/ --cov=backend.notifications --cov=telegram_bot.learn_notify
```

### Требования для тестов

- **PostgreSQL** - для интеграционных тестов
- **Telegram Bot Token** - для реальных тестов отправки
- **psutil** - для тестов использования памяти (опционально)

### Особенности тестирования

#### Изоляция тестов
- Каждый тест создает свои тестовые данные
- Автоматическая очистка после тестов
- Уникальные `telegram_id` для избежания конфликтов

#### Тестовые курсы
- Создаются с `enable_notify=True` для тестов прогресс-слотов
- Включают тестовые уроки для проверки прогресса
- Автоматически удаляются после тестов

#### Моки и реальные данные
- Unit-тесты используют моки БД
- Интеграционные тесты работают с реальной БД
- Реальные тесты отправляют в Telegram

#### Проверка дедупликации
- Тесты создают одинаковые уведомления несколько раз
- Проверяют, что количество не увеличивается
- Тестируют конкурентное создание

### Покрытие функциональности

✅ **Планирование уведомлений**
- Приветственные сообщения для новичков и профи
- Прогресс-слоты с динамическим контентом
- Уведомления об окончании доступа

✅ **Обработка очереди**
- Воркер уведомлений
- Резолв сообщений по прогрессу
- Отправка с ретраями
- Умная отмена уведомлений

✅ **Интеграция с курсами**
- Фильтрация по `enable_notify`
- Проверка прогресса по курсу
- Подстановка названий курсов

✅ **Обработка ошибок**
- Telegram API ошибки
- Ошибки БД
- Некорректные данные

✅ **Производительность**
- Массовые операции
- Конкурентность
- Использование памяти

Все критические функции системы уведомлений покрыты тестами и работают корректно.
